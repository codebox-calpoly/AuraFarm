datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL") // Required for Prisma 6 - Prisma 7 warning can be ignored
}

generator client {
  provider = "prisma-client-js"
}

enum UserRole {
  user
  admin
}

model User {
  id              Int                   @id @default(autoincrement())
  email           String                @unique
  name            String
  role            UserRole              @default(user)
  auraPoints      Int                   @default(0)
  streak          Int                   @default(0)
  lastCompletedAt DateTime? // For streak tracking
  createdAt       DateTime              @default(now())
  completions     ChallengeCompletion[] // Reverse relation
  flags           Flag[] // Flags they've submitted

  @@index([auraPoints])
}

model Challenge {
  id           Int                   @id @default(autoincrement())
  title        String
  description  String
  latitude     Float
  longitude    Float
  difficulty   String
  pointsReward Int
  createdAt    DateTime              @default(now())
  completions  ChallengeCompletion[] // Reverse relation

  @@index([createdAt])
  @@index([difficulty])
}

model ChallengeCompletion {
  id          Int       @id @default(autoincrement())
  userId      Int
  challengeId Int
  latitude    Float
  longitude   Float
  completedAt DateTime  @default(now())
  user        User      @relation(fields: [userId], references: [id])
  challenge   Challenge @relation(fields: [challengeId], references: [id])
  flags       Flag[] // Flags on this completion

  @@unique([userId, challengeId]) // Prevent duplicate completions
  @@index([userId]) // Index for faster user completion queries
  @@index([challengeId]) // Index for faster challenge completion queries
  @@index([completedAt])
  @@index([userId, completedAt])
}

model Flag {
  id           Int                 @id @default(autoincrement())
  completionId Int
  flaggedById  Int
  reason       String?
  createdAt    DateTime            @default(now())
  completion   ChallengeCompletion @relation(fields: [completionId], references: [id])
  flaggedBy    User                @relation(fields: [flaggedById], references: [id])

  @@unique([completionId, flaggedById]) // Prevent duplicate flags from same user
  @@index([completionId]) // Index for faster completion flag queries
  @@index([flaggedById]) // Index for faster user flag queries
}
